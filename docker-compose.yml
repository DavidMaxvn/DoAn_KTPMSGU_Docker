services:
  # Website UI (Razor MVC)
  webui:
    build:
      context: .
      dockerfile: AppView/Dockerfile
    image: doan_ktpm_appview:latest
    container_name: doan_appview
    ports:
      - "8080:80"
      - "8443:443"
    environment:
      - ASPNETCORE_URLS=http://+:80;https://+:443
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/AppAPI.pfx
      - ASPNETCORE_Kestrel__Certificates__Default__Password=123
      # Base URL Ä‘á»ƒ View Ä‘á»c tá»« env, khÃ´ng hard-code
      - API_BASE_URL=https://localhost:5443
    volumes:
      - ${USERPROFILE}\.aspnet\https:/https:ro
      - ./img:/app/wwwroot/img:ro   # áº£nh tÄ©nh do webui phá»¥c vá»¥
    depends_on:
      db:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
      webapi:
        condition: service_started

  # Web API
  webapi:
    build:
      context: .
      dockerfile: AppAPI/Dockerfile
      target: final
      args:
        - CONFIGURATION=Release
    image: doan_ktpm_appapi:latest
    container_name: appapi
    ports:
      - "5080:80"
      - "5443:443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80;https://+:443
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/AppAPI.pfx
      - ASPNETCORE_Kestrel__Certificates__Default__Password=123
      # âœ… Äáº·t connection string Ä‘Ãºng chuáº©n ASP.NET
      - ConnectionStrings__DBContext=Server=tcp:db,1433;Database=AppBanQuanAoThoiTrangNam;User Id=sa;Password=S3cure!Pass2025;Encrypt=False;TrustServerCertificate=True;MultipleActiveResultSets=True;TransparentNetworkIPResolution=False;
    volumes:
      - ${USERPROFILE}\.aspnet\https:/https:ro
    depends_on:
      db:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully

  # SQL Server
  db:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=S3cure!Pass2025
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P 'S3cure!Pass2025' -Q 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 20s
    volumes:
      - dbdata:/var/opt/mssql

  # Cháº¡y 1 láº§n Ä‘á»ƒ táº¡o DB + import script
  db-init:
    image: mcr.microsoft.com/mssql/server:2019-latest
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./scriptquanao_new.sql:/seeds/script_appdb.sql:ro
      # Náº¿u cÃ³ script riÃªng cho AppBanQuanAoThoiTrangNam thÃ¬ má»Ÿ dÃ²ng dÆ°á»›i:
      # - ./script_appbqtn.sql:/seeds/script_appbqtn.sql:ro
    entrypoint: ["/bin/bash","-lc"]
    command: >
      '
      set -e
      echo "â³ Chá» SQL sáºµn sÃ ng...";
      until /opt/mssql-tools18/bin/sqlcmd -C -S db -U sa -P "S3cure!Pass2025" -Q "SELECT 1" >/dev/null 2>&1; do sleep 1; done;

      echo "âœ… Táº¡o DB náº¿u chÆ°a cÃ³: AppBanQuanAoThoiTrangNam";
      /opt/mssql-tools18/bin/sqlcmd -C -S db -U sa -P "S3cure!Pass2025" -Q "IF DB_ID(''AppBanQuanAoThoiTrangNam'') IS NULL CREATE DATABASE [AppBanQuanAoThoiTrangNam];"

      echo "ðŸ“¥ Import script vÃ o AppBanQuanAoThoiTrangNam";
      if [ -f /seeds/script_appbqtn.sql ]; then
        /opt/mssql-tools18/bin/sqlcmd -C -S db -U sa -P "S3cure!Pass2025" -d "AppBanQuanAoThoiTrangNam" -i /seeds/script_appbqtn.sql
      else
        /opt/mssql-tools18/bin/sqlcmd -C -S db -U sa -P "S3cure!Pass2025" -d "AppBanQuanAoThoiTrangNam" -i /seeds/script_appdb.sql
      fi

      echo "ðŸŽ‰ Seed xong!";
      '
    restart: "no"

networks:
  default:
    name: doan_ktpmsgu_default

volumes:
  dbdata:
