services:
  db:
    build:
      context: .
      dockerfile: docker/database/Dockerfile
    image: doan_ktpmsgu_db:latest
    container_name: doan_db
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_PID: Developer
      SA_PASSWORD: S3cure!Pass2025
    ports:
      - "1433:1433"
    volumes:
      - dbdata:/var/opt/mssql
    restart: unless-stopped

  db-migrator:
    build:
      context: .
      dockerfile: AppData/Dockerfile
    image: doan_ktpmsgu_migrator:latest
    depends_on:
      db:
        condition: service_healthy
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__DBContext: Server=tcp:db,1433;Database=AppBanQuanAoThoiTrangNam;User Id=sa;Password=S3cure!Pass2025;Encrypt=False;TrustServerCertificate=True;MultipleActiveResultSets=True;TransparentNetworkIPResolution=False;
      MIGRATION_MAX_RETRIES: "40"
      MIGRATION_RETRY_DELAY: "5"
    restart: "no"

  webapi:
    build:
      context: .
      dockerfile: AppAPI/Dockerfile
    image: doan_ktpmsgu_appapi:latest
    container_name: doan_webapi
    depends_on:
      db:
        condition: service_healthy
      db-migrator:
        condition: service_completed_successfully
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      ConnectionStrings__DBContext: Server=tcp:db,1433;Database=AppBanQuanAoThoiTrangNam;User Id=sa;Password=S3cure!Pass2025;Encrypt=False;TrustServerCertificate=True;MultipleActiveResultSets=True;TransparentNetworkIPResolution=False;
    ports:
      - "5080:80"
    restart: unless-stopped

  webui:
    build:
      context: .
      dockerfile: AppView/Dockerfile
    image: doan_ktpmsgu_appview:latest
    container_name: doan_webui
    depends_on:
      webapi:
        condition: service_started
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:80
      API_BASE_URL: http://localhost:5080
    ports:
      - "8080:80"
    volumes:
      - ./img:/app/wwwroot/img
    restart: unless-stopped

volumes:
  dbdata:
