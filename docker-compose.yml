services:
  # Website UI (Razor MVC)
  webui:
    build:
      context: .
      dockerfile: AppView/Dockerfile
    image: doan_ktpm_appview:latest
    container_name: doan_appview
    ports:
      - "8080:80"      # HTTP -> UI
      - "8443:443"     # HTTPS -> UI
    environment:
      # Bật cả HTTP và HTTPS trong container
      - ASPNETCORE_URLS=http://+:80;https://+:443
      - ASPNETCORE_ENVIRONMENT=Development
      # Mount dev cert từ Windows vào container (Cách B)
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/AppAPI.pfx
      - ASPNETCORE_Kestrel__Certificates__Default__Password=123  # đổi đúng mật khẩu bạn đã export
      # (nếu UI cần gọi API bằng HttpClient, bạn có thể đặt BASE_URL nội bộ)
      # - Api__BaseUrl=http://webapi:80
    volumes:
      - ${USERPROFILE}\.aspnet\https:/https:ro
    depends_on:
      - db
      - webapi

  # Web API
  webapi:
    build:
      context: .
      dockerfile: AppAPI/Dockerfile
      target: final
      args:
        - CONFIGURATION=Release
    image: doan_ktpm_appapi:latest
    container_name: doan_appapi
    # Có thể không expose ra ngoài, chỉ cho UI gọi nội bộ.
    # Nếu cần test ngoài, mở port khác để tránh trùng UI:
    ports:
      - "5080:80"
      - "5443:443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80;https://+:443
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/AppAPI.pfx
      - ASPNETCORE_Kestrel__Certificates__Default__Password=123
      - ConnectionStrings__DBContext=Server=db;Database=AppDb;User=sa;Password=123;TrustServerCertificate=True;
    volumes:
      - ${USERPROFILE}\.aspnet\https:/https:ro
    depends_on:
      - db

  # SQL Server
  db:
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: doan_db
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=S3cure!Pass2025
    ports:
      - "1433:1433"
    volumes:
      - dbdata:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 'S3cure!Pass2025' -Q 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

volumes:
  dbdata:
