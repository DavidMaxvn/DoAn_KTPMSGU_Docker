version: "3.9"

services:
  db:
    build:
      context: .
      dockerfile: docker/database/Dockerfile
    container_name: doan_db
    environment:
      - SA_PASSWORD=${SA_PASSWORD:-S3cure!Pass2025}
      - ACCEPT_EULA=Y
      - MSSQL_PID=Developer
    ports:
      - "1433:1433"
    volumes:
      - dbdata:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "(/opt/mssql-tools18/bin/sqlcmd -C -S localhost -U sa -P '$$SA_PASSWORD' -Q 'SELECT 1' || /opt/mssql-tools/bin/sqlcmd -C -S localhost -U sa -P '$$SA_PASSWORD' -Q 'SELECT 1')"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 20s

  migrations:
    build:
      context: .
      dockerfile: AppData/Dockerfile
    container_name: doan_migrations
    depends_on:
      db:
        condition: service_healthy
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DBContext=Server=tcp:db,1433;Database=AppBanQuanAoThoiTrangNam;User Id=sa;Password=${SA_PASSWORD:-S3cure!Pass2025};Encrypt=False;TrustServerCertificate=True;MultipleActiveResultSets=True;TransparentNetworkIPResolution=False;
    restart: "no"

  webapi:
    build:
      context: .
      dockerfile: AppAPI/Dockerfile
    container_name: doan_api
    depends_on:
      db:
        condition: service_healthy
      migrations:
        condition: service_completed_successfully
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DBContext=Server=tcp:db,1433;Database=AppBanQuanAoThoiTrangNam;User Id=sa;Password=${SA_PASSWORD:-S3cure!Pass2025};Encrypt=False;TrustServerCertificate=True;MultipleActiveResultSets=True;TransparentNetworkIPResolution=False;
    ports:
      - "5080:80"

  webui:
    build:
      context: .
      dockerfile: AppView/Dockerfile
    container_name: doan_view
    depends_on:
      webapi:
        condition: service_started
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ApiBaseUrl=http://webapi
    volumes:
      - ./img:/app/wwwroot/img
    ports:
      - "8080:80"

volumes:
  dbdata:
