services:
  web:
    build:
      context: .
      dockerfile: AppAPI/Dockerfile
      target: final
      args:
        - CONFIGURATION=Release
    image: doan_ktpm_appapi:latest
    ports:
      - "8080:80"      # HTTP ->  http://localhost:8080
      - "8443:443"     # HTTPS -> https://localhost:8443
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      # Kestrel lắng nghe cả HTTP/HTTPS trong container
      - ASPNETCORE_URLS=http://+:80;https://+:443
      # Chỉ ra đường dẫn & password của cert bên trong container
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/AppAPI.pfx
      - ASPNETCORE_Kestrel__Certificates__Default__Password=123  # <= TRÙNG với bước export
      # KẾT NỐI DB: NHỚ đồng bộ mật khẩu với db.SA_PASSWORD bên dưới!
      - ConnectionStrings__DBContext=Server=db;Database=AppDb;User=sa;Password=123;
    volumes:
      # Mount cert PFX từ Windows host vào container /https
      - ${USERPROFILE}\.aspnet\https:/https:ro
      # Lưu DataProtection Keys để cookie/antiforgery không reset mỗi lần recreate
      - dpkeys:/root/.aspnet/DataProtection-Keys
    depends_on:
      - db

  db:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      - ACCEPT_EULA=Y
      # SQL Server yêu cầu mật khẩu mạnh (>=8 ký tự, hoa/thường/số/ký tự đặc biệt)
      - SA_PASSWORD='S3cure!Pass2025'
    ports:
      - "1433:1433"
    volumes:
      - dbdata:/var/opt/mssql

volumes:
  dbdata:
  dpkeys:
